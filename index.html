<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM驱动RPG Demo</title>
    <link rel="stylesheet" href="./assets/styles/game.css">
    <link rel="stylesheet" href="./assets/styles/ui-components.css">
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>地牢探险 Demo</h2>
            <p>正在初始化游戏系统...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
        </div>
    </div>

    <!-- 游戏主界面容器，将由GameView.js填充 -->
    <div id="game-root"></div>

    <!-- 错误显示容器 -->
    <div id="error-container" class="error-container hidden">
        <div class="error-content">
            <h2>🚫 游戏启动失败</h2>
            <p id="error-message"></p>
            <div class="error-details">
                <p>请确保：</p>
                <ul>
                    <li>在正确的iframe环境中运行</li>
                    <li>小白X插件已正确加载</li>
                    <li>callGenerate函数可用</li>
                </ul>
            </div>
            <button onclick="location.reload()" class="retry-button">重试</button>
        </div>
    </div>

    <!-- 调试面板 (可选) -->
    <div id="debug-panel" class="debug-panel hidden">
        <div class="debug-header">
            <h3>调试信息</h3>
            <button onclick="toggleDebugPanel()" class="debug-close">×</button>
        </div>
        <div class="debug-content">
            <div class="debug-section">
                <h4>游戏状态</h4>
                <pre id="debug-game-state"></pre>
            </div>
            <div class="debug-section">
                <h4>事件日志</h4>
                <div id="debug-event-log" class="debug-log"></div>
            </div>
        </div>
    </div>

    <!-- 模块化JavaScript加载 -->
    <script type="module">
        // 动态加载模块并显示进度
        const modules = [
            './src/core/EventBus.js',
            './src/core/ServiceLocator.js', 
            './src/models/GameState.js',
            './src/services/LLMService.js',
            './src/services/FunctionCallService.js',
            './src/services/GameStateService.js',
            './src/controllers/GameController.js',
            './src/views/GameView.js',
            './src/core/GameCore.js'
        ];

        let loadedCount = 0;
        const progressBar = document.getElementById('loadingBar');

        function updateProgress() {
            loadedCount++;
            const progress = (loadedCount / modules.length) * 100;
            progressBar.style.width = progress + '%';
            
            if (loadedCount === modules.length) {
                // 所有模块加载完成，启动游戏
                setTimeout(() => {
                    import('./index.js');
                }, 500);
            }
        }

        // 预加载所有模块
        modules.forEach(module => {
            import(module).then(() => {
                updateProgress();
            }).catch(error => {
                console.error('Failed to load module:', module, error);
                showError(`模块加载失败: ${module}`);
            });
        });

        // 错误处理函数
        function showError(message) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').classList.remove('hidden');
        }

        // 调试面板控制
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('debug-panel');
            panel.classList.toggle('hidden');
        };

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            // Ctrl+D 开启调试面板
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebugPanel();
            }
            // ESC 关闭调试面板
            if (e.key === 'Escape') {
                document.getElementById('debug-panel').classList.add('hidden');
            }
        });
    </script>
</body>
</html>